<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Simonla&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Simonla's Blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Simonla's Blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Simonla's Blog">
  
    <link rel="alternate" href="/atom.xml" title="Simonla&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Simonla&#39;s Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">艺术与生活</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-AsyncTask 源码浅析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/04/20/AsyncTask 源码浅析/" class="article-date">
  <time datetime="2017-04-20T02:33:00.000Z" itemprop="datePublished">2017-04-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android/">Android</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/20/AsyncTask 源码浅析/">AsyncTask 源码浅析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h2><p>是围绕<code>Handler</code>和<code>Thread</code>开发的帮助类,方便开发者在子线程执行<strong>几秒钟以内</strong>的耗时任务，在主线程返回任务执行的结果。简而言之，是对异步操作的封装</p>
<h2 id="四个重要回调方法"><a href="#四个重要回调方法" class="headerlink" title="四个重要回调方法"></a>四个重要回调方法</h2><ul>
<li>onPreExecute()</li>
<li>doInBackground()</li>
<li>onProgressUpdate()</li>
<li>onPostExecute()</li>
</ul>
<p>只有doInBackground()在线程池执行，其余方法在主线程执行</p>
<h2 id="执行过程"><a href="#执行过程" class="headerlink" title="执行过程"></a>执行过程</h2><h3 id="1-编译期创建线程池"><a href="#1-编译期创建线程池" class="headerlink" title="1. 编译期创建线程池"></a>1. 编译期创建线程池</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CPU_COUNT = Runtime.getRuntime().availableProcessors();</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CORE_POOL_SIZE = Math.max(<span class="number">2</span>, Math.min(CPU_COUNT - <span class="number">1</span>, <span class="number">4</span>));</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAXIMUM_POOL_SIZE = CPU_COUNT * <span class="number">2</span> + <span class="number">1</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> KEEP_ALIVE_SECONDS = <span class="number">30</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadFactory sThreadFactory = <span class="keyword">new</span> ThreadFactory() &#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger mCount = <span class="keyword">new</span> AtomicInteger(<span class="number">1</span>);</div><div class="line">    <span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable r)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Thread(r, <span class="string">"AsyncTask #"</span> + mCount.getAndIncrement());</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; </div><div class="line">sPoolWorkQueue =<span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;(<span class="number">128</span>);</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Executor THREAD_POOL_EXECUTOR;</div><div class="line"></div><div class="line"><span class="keyword">static</span> &#123;</div><div class="line">    ThreadPoolExecutor threadPoolExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</div><div class="line">                CORE_POOL_SIZE, MAXIMUM_POOL_SIZE, </div><div class="line">                KEEP_ALIVE_SECONDS, TimeUnit.SECONDS,</div><div class="line">                sPoolWorkQueue, sThreadFactory);</div><div class="line">    <span class="comment">//超过闲置等待时间后允许回收所有线程，包括核心线程</span></div><div class="line">    threadPoolExecutor.allowCoreThreadTimeOut(<span class="keyword">true</span>);</div><div class="line">    THREAD_POOL_EXECUTOR = threadPoolExecutor;</div><div class="line">&#125;</div><div class="line"><span class="comment">//默认的Executor</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Executor SERIAL_EXECUTOR = <span class="keyword">new</span> SerialExecutor();</div></pre></td></tr></table></figure>
<p><code>THREAD_POOL_EXECUTOR</code>即AsyncTask的线程池之一，根据<code>Math.max(2, Math.min(CPU_COUNT - 1, 4))</code>设置线程池的<strong>核心线程数</strong>最小为2，最大为4，<strong>最大线程数</strong>为<code>CPU_COUNT * 2 + 1</code>，线程闲置等待时间为30秒，任务队列<code>LinkedBlockingQueue</code>最大长度为128，线程工厂设置线程的name为<code>AsyncTask # i++</code></p>
<p><code>THREAD_POOL_EXECUTOR</code>和<code>SERIAL_EXECUTOR</code>会被所有AsyncTask实例共用</p>
<h3 id="2-构造方法"><a href="#2-构造方法" class="headerlink" title="2. 构造方法"></a>2. 构造方法</h3><p>只做了两件事，初始化<code>mWorker</code>（也就是<code>Callable</code>）和<code>mFuture</code>(也就是<code>FutureTask</code>) 属于Java并发包下的两个类，下面对他们进行简单的介绍</p>
<ul>
<li><code>Callable</code> 简单来说就是可以抛出异常的，有返回值的<code>Runnable</code></li>
<li><code>FutureTask</code> 扩展了<code>RunnableFuture</code>，而<code>RunnableFuture</code>又扩展了<code>Runnable</code>和<code>Future</code>。将会执行构造方法传入的<code>Callable</code>，并取得返回值</li>
</ul>
<p>虽然这两个类里的方法还没有被调用<br>但是我们却可以很清晰的看见整个AsyncTask的工作流程了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">AsyncTask</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">//实现了Callable</span></div><div class="line">    mWorker = <span class="keyword">new</span> WorkerRunnable&lt;Params, Result&gt;() &#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> Result <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">            <span class="comment">//标识有任务被调用了</span></div><div class="line">            mTaskInvoked.set(<span class="keyword">true</span>);</div><div class="line">            Result result = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">//标准的后台线程优先级，优先级不是太高 </span></div><div class="line">                Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</div><div class="line">                <span class="comment">//调用我们的四个重要抽象方法之二</span></div><div class="line">                result = doInBackground(mParams);</div><div class="line">                Binder.flushPendingCommands();</div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable tr) &#123;</div><div class="line">                mCancelled.set(<span class="keyword">true</span>);</div><div class="line">                <span class="keyword">throw</span> tr;</div><div class="line">            &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                <span class="comment">//Handler调用，暂且按下不表</span></div><div class="line">                postResult(result);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> result;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    mFuture = <span class="keyword">new</span> FutureTask&lt;Result&gt;(mWorker) &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">done</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">//处理未能顺利完成调用的情况</span></div><div class="line">                postResultIfNotInvoked(get());</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                android.util.Log.w(LOG_TAG, e);</div><div class="line">            &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"An error occurred while executing doInBackground()"</span>,</div><div class="line">                        e.getCause());</div><div class="line">            &#125; <span class="keyword">catch</span> (CancellationException e) &#123;</div><div class="line">                postResultIfNotInvoked(<span class="keyword">null</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-executeOnExecutor"><a href="#3-executeOnExecutor" class="headerlink" title="3.  executeOnExecutor"></a>3.  <code>executeOnExecutor</code></h3><p>所有的执行命令最终都会调用这个方法<br>所以是我们开始使用AsyncTask的第一站<br>这个方法只能在主线程调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@MainThread</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> AsyncTask&lt;Params, Progress, Result&gt; <span class="title">executeOnExecutor</span><span class="params">(Executor exec,</span></span></div><div class="line">        Params... params) &#123;</div><div class="line">    <span class="keyword">if</span> (mStatus != Status.PENDING) &#123;</div><div class="line">        <span class="keyword">switch</span> (mStatus) &#123;</div><div class="line">            <span class="keyword">case</span> RUNNING:</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot execute task:"</span></div><div class="line">                        + <span class="string">" the task is already running."</span>);</div><div class="line">            <span class="keyword">case</span> FINISHED:</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot execute task:"</span></div><div class="line">                        + <span class="string">" the task has already been executed "</span></div><div class="line">                        + <span class="string">"(a task can be executed only once)"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//设置状态为RUNNING</span></div><div class="line">    mStatus = Status.RUNNING;</div><div class="line">    <span class="comment">//调用我们四个重要抽象方法之一</span></div><div class="line">    onPreExecute();</div><div class="line">    <span class="comment">//把Params传给我们实现Caller的Worker</span></div><div class="line">    mWorker.mParams = params;</div><div class="line">    <span class="comment">//调用Executor执行，同时把我们的FutureTask传进去</span></div><div class="line">    <span class="comment">//默认的Executor是在编译器就初始化好的SERIAL_EXECUTOR，串行执行</span></div><div class="line">    exec.execute(mFuture);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接下来会调用<code>Executor.execute()</code><br>下面看一下我们默认的Executor，也就是SerialExecutor</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SerialExecutor</span> <span class="keyword">implements</span> <span class="title">Executor</span> </span>&#123;</div><div class="line">    <span class="comment">//线性双端队列</span></div><div class="line">    <span class="keyword">final</span> ArrayDeque&lt;Runnable&gt; mTasks = <span class="keyword">new</span> ArrayDeque&lt;Runnable&gt;();</div><div class="line">    Runnable mActive;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> Runnable r)</span> </span>&#123;</div><div class="line">        <span class="comment">//提交一个Runnable到双端队列</span></div><div class="line">        mTasks.offer(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    <span class="comment">//运行我们的mFuture，忘记了这是啥？回去看第二部分</span></div><div class="line">                    r.run();</div><div class="line">                &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                    <span class="comment">//调度下一个</span></div><div class="line">                    scheduleNext();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        <span class="comment">//如果没有正在活动的任务，就调度下一个</span></div><div class="line">        <span class="keyword">if</span> (mActive == <span class="keyword">null</span>) &#123;</div><div class="line">            scheduleNext();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">scheduleNext</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> ((mActive = mTasks.poll()) != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">//终于提交到线程池执行了，THREAD_POOL_EXECUTOR是啥？忘了的话去看第一部分</span></div><div class="line">            THREAD_POOL_EXECUTOR.execute(mActive);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="4-THREAD-POOL-EXECUTOR中的调用"><a href="#4-THREAD-POOL-EXECUTOR中的调用" class="headerlink" title="4. THREAD_POOL_EXECUTOR中的调用"></a>4. <code>THREAD_POOL_EXECUTOR</code>中的调用</h3><p>这一部分其实已经超出了我们分析的范围了，所以 我们不会去关心线程池的实现，而是理一理调用流程就好</p>
<p>记住了，我们<code>execute</code>到线程池的<code>Runnable</code>，是<code>poll</code>到<code>ArrayDeque</code>的<code>Runnable</code>，这个<code>Runnable</code>中调用了<code>mFuture.run()</code>，</p>
<p>我们关心的是传到线程池的<code>Runnable</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable command)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (command == <span class="keyword">null</span>)</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">    <span class="keyword">int</span> c = ctl.get();</div><div class="line">    <span class="keyword">if</span> (workerCountOf(c) &lt; corePoolSize) &#123;</div><div class="line">        <span class="keyword">if</span> (addWorker(command, <span class="keyword">true</span>))</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        c = ctl.get();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123;</div><div class="line">        <span class="keyword">int</span> recheck = ctl.get();</div><div class="line">        <span class="keyword">if</span> (! isRunning(recheck) &amp;&amp; remove(command))</div><div class="line">            reject(command);</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (workerCountOf(recheck) == <span class="number">0</span>)</div><div class="line">            addWorker(<span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!addWorker(command, <span class="keyword">false</span>))</div><div class="line">        reject(command);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个方法没啥说的，就是做一下检查，然后调用<code>addWorker()</code>，这个方法里面，会找到一个由<code>ThreadFactory</code>创建的线程，这个第一部分我们有交代，然后在这个线程中调用<code>Runnable.run()</code>，最终调用到<code>mFurture.run( )</code> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (state != NEW ||</div><div class="line">        !U.compareAndSwapObject(<span class="keyword">this</span>, RUNNER, <span class="keyword">null</span>, Thread.currentThread()))</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">//构造方法传进来的callable，对应于AsyncTask中的mWorker，我们第二部分有讲</span></div><div class="line">        Callable&lt;V&gt; c = callable;</div><div class="line">        <span class="keyword">if</span> (c != <span class="keyword">null</span> &amp;&amp; state == NEW) &#123;</div><div class="line">            V result;</div><div class="line">            <span class="keyword">boolean</span> ran;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">//调用mWorker.call()，并且取得返回值。我们第二部分有讲</span></div><div class="line">                result = c.call();</div><div class="line">                ran = <span class="keyword">true</span>;</div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</div><div class="line">                result = <span class="keyword">null</span>;</div><div class="line">                ran = <span class="keyword">false</span>;</div><div class="line">                setException(ex);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (ran)</div><div class="line">                set(result);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        runner = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">int</span> s = state;</div><div class="line">        <span class="keyword">if</span> (s &gt;= INTERRUPTING)</div><div class="line">            handlePossibleCancellationInterrupt(s);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里面都是在子线程操作了哈，调用了mWorker.call()，回调了四个重要抽象方法的<code>doInBackground()</code>哈，然后这个方法的返回值作为result，这个result交给Handler了咯，完了后调用<code>mFuture.done()</code></p>
<h3 id="5-Handler中的调用"><a href="#5-Handler中的调用" class="headerlink" title="5. Handler中的调用"></a>5. Handler中的调用</h3><p>先看看<code>mWorker.call()</code>中的<code>postResult(result);</code><br>这里面都是在子线程执行的，所以用<code>Handler</code>返回主线程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Result <span class="title">postResult</span><span class="params">(Result result)</span> </span>&#123;</div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">    <span class="comment">//result是我们在doInBackground()返回的值</span></div><div class="line">    Message message = getHandler().obtainMessage(MESSAGE_POST_RESULT,</div><div class="line">            <span class="keyword">new</span> AsyncTaskResult&lt;Result&gt;(<span class="keyword">this</span>, result));</div><div class="line">    message.sendToTarget();</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Handler <span class="title">getHandler</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">synchronized</span> (AsyncTask.class) &#123;</div><div class="line">        <span class="keyword">if</span> (sHandler == <span class="keyword">null</span>) &#123;</div><div class="line">            sHandler = <span class="keyword">new</span> InternalHandler();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> sHandler;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">InternalHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InternalHandler</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(Looper.getMainLooper());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"unchecked"</span>, <span class="string">"RawUseOfParameterizedType"</span>&#125;)</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">        AsyncTaskResult&lt;?&gt; result = (AsyncTaskResult&lt;?&gt;) msg.obj;</div><div class="line">        <span class="keyword">switch</span> (msg.what) &#123;</div><div class="line">            <span class="keyword">case</span> MESSAGE_POST_RESULT:</div><div class="line">                result.mTask.finish(result.mData[<span class="number">0</span>]);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> MESSAGE_POST_PROGRESS:</div><div class="line">                result.mTask.onProgressUpdate(result.mData);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>case MESSAGE_POST_RESULT:</code> 调用了<code>finish()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">finish</span><span class="params">(Result result)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (isCancelled()) &#123;</div><div class="line">        onCancelled(result);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        onPostExecute(result);</div><div class="line">    &#125;</div><div class="line">    mStatus = Status.FINISHED;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后调用<code>onPostExecute(result)</code>，整个流程结束</p>
<p><code>publishProgress()</code>还是借助的<code>AsyncTaskResult&lt;DATA&gt;</code>，没什么好分析的，但是代码还是贴出来</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">publishProgress</span><span class="params">(Progress... values)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!isCancelled()) &#123;</div><div class="line">        getHandler().obtainMessage(MESSAGE_POST_PROGRESS,</div><div class="line">                <span class="keyword">new</span> AsyncTaskResult&lt;Progress&gt;(<span class="keyword">this</span>, values)).sendToTarget();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><code>AsyncTask</code>利用Java并发包下的<code>FutureTask</code>来封装了一次请求的信息，<code>SerialExecutor</code>来保证串行执行，利用<code>THREAD_POOL_EXECUTOR</code>线程池在子线程执行任务，用<code>Handler</code>返回主线程</p>
<p>线程池中子线程执行的是在<code>SerialExecutor</code>中添加到<code>ArrayDeque</code>的<code>Runnable</code>，这里面会串行的调用<code>Runnable</code>中的<code>mFuture.run()</code>，<code>mFuture.run()</code>会调用<code>mWorker.call()</code>，<code>mWorker.call()</code>会回调<code>doInBackground()</code>并且取得返回值</p>
<h4 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h4><ul>
<li>足够的轻巧，全局维护仅一个线性的队列，一个线程池</li>
<li>相比<code>Handler</code>来说，足够的方便</li>
<li>编写好一个AsyncTask后，有一定的复用性</li>
</ul>
<h4 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h4><ul>
<li>需要继承<code>AsyncTask</code>，如果它作为<code>Activity</code>的内部类，要小心内存泄漏</li>
<li>虽然提供了一个API来取消一次请求，但是不一定能够取消掉</li>
<li>一次事件的起因和结果是耦合在一起的</li>
<li>除了足够轻巧，都不如<code>RxJava</code>，体现在你无法合理的控制流程，怎么合并多个任务？怎么串联多个任务？怎么拆分多个任务？流程中出现错误怎么办？</li>
</ul>
<p>终上所述，AsyncTask的使用价值以及不足够明显，我们不需要再使用它了</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/04/20/AsyncTask 源码浅析/" data-id="cj1psth850001fliqdg3akgtb" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Android消息机制自问自答" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/04/18/Android消息机制自问自答/" class="article-date">
  <time datetime="2017-04-18T12:52:00.000Z" itemprop="datePublished">2017-04-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android/">Android</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/18/Android消息机制自问自答/">Android消息机制自问自答</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Handler-是用来做什么的？"><a href="#Handler-是用来做什么的？" class="headerlink" title="Handler 是用来做什么的？"></a>Handler 是用来做什么的？</h2><p>总的来说，Handler是一个跨线程发送Message对象的工具</p>
<p>对应用层来说，Android不允许主线程以外的线程更新UI，所以需要借助Handler来更新UI</p>
<p>对Framework来说，AMS通过Binder跨进程，发送消息到ApplicationThread，<code>ApplicationThread</code>向<code>H</code>(继承自Handler)发送消息，H收到消息后再ActivityThread中处理</p>
<h2 id="Handler-Looper-MessageQueue-Message-四者关系？"><a href="#Handler-Looper-MessageQueue-Message-四者关系？" class="headerlink" title="Handler Looper MessageQueue Message 四者关系？"></a>Handler Looper MessageQueue Message 四者关系？</h2><p><img src="https://lh3.googleusercontent.com/-kQPf6BFtjyQ/WPYIkvhNg8I/AAAAAAAAEAQ/SvDIZZJ_nRk/I/14925176027196.jpg" alt=""></p>
<h2 id="一次完整的Handler使用流程是怎么样的？"><a href="#一次完整的Handler使用流程是怎么样的？" class="headerlink" title="一次完整的Handler使用流程是怎么样的？"></a>一次完整的Handler使用流程是怎么样的？</h2><p><img src="https://lh3.googleusercontent.com/-uweFv-yfo3U/WPYIXz1HrWI/AAAAAAAAEAI/-rpcCf1I7AE/I/14924418735047.jpg" alt="使用流程"></p>
<p>一、Looper.prepare( ):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(<span class="keyword">boolean</span> quitAllowed)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (sThreadLocal.get() != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Only one Looper may be created per thread"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//设置Looper到ThreadLocal</span></div><div class="line">    sThreadLocal.set(<span class="keyword">new</span> Looper(quitAllowed));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>二、在消费线程实例化Handler，Handler在ThreadLocal中放置属于此线程的Looper。设置将来获得Message的方法（复写<code>dispatchMessage()</code>方法，或者通过接口回调）</p>
<p>Handler 所有的构造方法：<br><img src="https://lh3.googleusercontent.com/-23Cepdc4AT0/WPYIYH6LGdI/AAAAAAAAEAM/hZYhf09cREs/I/14924252597967.jpg" alt="Handler 所有的构造方法"></p>
<p>Handler获得Looper有两种途径：</p>
<ol>
<li>构造方法</li>
<li><code>Looper.myLooper()</code>的静态方法</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Handler</span><span class="params">(Callback callback, <span class="keyword">boolean</span> async)</span> </span>&#123;</div><div class="line">    <span class="comment">//Looper从ThreadLocal获得该线程的mLooper</span></div><div class="line">    mLooper = Looper.myLooper();</div><div class="line">    <span class="keyword">if</span> (mLooper == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</div><div class="line">            <span class="string">"Can't create handler inside thread that has not called Looper.prepare()"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//获得该线程的MessageQueue</span></div><div class="line">    mQueue = mLooper.mQueue;</div><div class="line">    mCallback = callback;</div><div class="line">    mAsynchronous = async;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>三、在另一个线程，用Handler的引用，发送Message</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//最终会调用该方法</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">sendMessageAtTime</span><span class="params">(Message msg, <span class="keyword">long</span> uptimeMillis)</span> </span>&#123;</div><div class="line">    MessageQueue queue = mQueue;</div><div class="line">    <span class="keyword">if</span> (queue == <span class="keyword">null</span>) &#123;</div><div class="line">        RuntimeException e = <span class="keyword">new</span> RuntimeException(</div><div class="line">                <span class="keyword">this</span> + <span class="string">" sendMessageAtTime() called with no mQueue"</span>);</div><div class="line">        Log.w(<span class="string">"Looper"</span>, e.getMessage(), e);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> enqueueMessage(queue, msg, uptimeMillis);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">enqueueMessage</span><span class="params">(MessageQueue queue, Message msg, <span class="keyword">long</span> uptimeMillis)</span> </span>&#123;</div><div class="line">    <span class="comment">//在Message中保存该Handler的引用</span></div><div class="line">    msg.target = <span class="keyword">this</span>;</div><div class="line">    <span class="keyword">if</span> (mAsynchronous) &#123;</div><div class="line">        msg.setAsynchronous(<span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//插入一条消息到单链表MessageQueue</span></div><div class="line">    <span class="keyword">return</span> queue.enqueueMessage(msg, uptimeMillis);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">enqueueMessage</span><span class="params">(Message msg, <span class="keyword">long</span> when)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (msg.target == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Message must have a target."</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//重复生产了多条相同的Message而没有被消费掉</span></div><div class="line">    <span class="keyword">if</span> (msg.isInUse()) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(msg + <span class="string">" This message is already in use."</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">        <span class="comment">//已经没有Looper啦，插不进去了</span></div><div class="line">        <span class="keyword">if</span> (mQuitting) &#123;</div><div class="line">            IllegalStateException e = <span class="keyword">new</span> IllegalStateException(</div><div class="line">                    msg.target + <span class="string">" sending message to a Handler on a dead thread"</span>);</div><div class="line">            Log.w(TAG, e.getMessage(), e);</div><div class="line">            msg.recycle();</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//标记正在使用</span></div><div class="line">        msg.markInUse();</div><div class="line">        msg.when = when;</div><div class="line">        <span class="comment">//哨兵</span></div><div class="line">        Message p = mMessages;</div><div class="line">        <span class="keyword">boolean</span> needWake;</div><div class="line">        <span class="comment">//此次传入的msg为头</span></div><div class="line">        <span class="keyword">if</span> (p == <span class="keyword">null</span> || when == <span class="number">0</span> || when &lt; p.when) &#123;</div><div class="line">            <span class="comment">//设置哨兵</span></div><div class="line">            msg.next = p;</div><div class="line">            <span class="comment">//mMessage更新为该msg</span></div><div class="line">            mMessages = msg;</div><div class="line">            needWake = mBlocked;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            needWake = mBlocked &amp;&amp; p.target == <span class="keyword">null</span> &amp;&amp; msg.isAsynchronous();</div><div class="line">            <span class="comment">//prev为msg的前一个</span></div><div class="line">            Message prev;</div><div class="line">            <span class="keyword">for</span> (;;) &#123;</div><div class="line">                <span class="comment">//既然p不为空，p即使msg的前一个</span></div><div class="line">                prev = p;</div><div class="line">                <span class="comment">//更新p为p的下一个</span></div><div class="line">                p = p.next;</div><div class="line">                <span class="comment">//p的下一个为空，意味着到达尾部，跳出</span></div><div class="line">                <span class="keyword">if</span> (p == <span class="keyword">null</span> || when &lt; p.when) &#123;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (needWake &amp;&amp; p.isAsynchronous()) &#123;</div><div class="line">                    needWake = <span class="keyword">false</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">//msg的下一个为p，p为空</span></div><div class="line">            msg.next = p;</div><div class="line">            <span class="comment">//插入到末尾</span></div><div class="line">            prev.next = msg;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (needWake) &#123;</div><div class="line">            nativeWake(mPtr);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>四、Looper.loop()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loop</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">//获得属于该线程的Looper</span></div><div class="line">    <span class="keyword">final</span> Looper me = myLooper();</div><div class="line">    <span class="keyword">if</span> (me == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"No Looper; Looper.prepare() wasn't called on this thread."</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//获得MessageQueue</span></div><div class="line">    <span class="keyword">final</span> MessageQueue queue = me.mQueue;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (;;) &#123;</div><div class="line">        <span class="comment">//循环去获取下一条消息</span></div><div class="line">        Message msg = queue.next(); </div><div class="line">        <span class="comment">//queue.next()返回null &lt;==&gt; 该线程的looper退出了</span></div><div class="line">        <span class="keyword">if</span> (msg == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">//msg.target返回Handler，Handler.dispatchMessage(msg)完成消息的传递</span></div><div class="line">            msg.target.dispatchMessage(msg);</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="keyword">if</span> (traceTag != <span class="number">0</span>) &#123;</div><div class="line">                Trace.traceEnd(traceTag);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line"><span class="function">Message <span class="title">next</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">long</span> ptr = mPtr;</div><div class="line">        <span class="keyword">if</span> (ptr == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">int</span> pendingIdleHandlerCount = -<span class="number">1</span>;</div><div class="line">        <span class="keyword">int</span> nextPollTimeoutMillis = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (;;) &#123;</div><div class="line">            <span class="keyword">if</span> (nextPollTimeoutMillis != <span class="number">0</span>) &#123;</div><div class="line">                Binder.flushPendingCommands();</div><div class="line">            &#125;</div><div class="line">            <span class="comment">//没有消息的话线程进入休眠</span></div><div class="line">            nativePollOnce(ptr, nextPollTimeoutMillis);</div><div class="line">            <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">long</span> now = SystemClock.uptimeMillis();</div><div class="line">                Message prevMsg = <span class="keyword">null</span>;</div><div class="line">                Message msg = mMessages;</div><div class="line">                <span class="keyword">if</span> (msg != <span class="keyword">null</span> &amp;&amp; msg.target == <span class="keyword">null</span>) &#123;</div><div class="line">                    do &#123;</div><div class="line">                        prevMsg = msg;</div><div class="line">                        msg = msg.next;</div><div class="line">                    &#125; <span class="keyword">while</span> (msg != <span class="keyword">null</span> &amp;&amp; !msg.isAsynchronous());</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (msg != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">if</span> (now &lt; msg.when) &#123;</div><div class="line">                        nextPollTimeoutMillis = (<span class="keyword">int</span>) Math.min(msg.when - now, Integer.MAX_VALUE);</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        mBlocked = <span class="keyword">false</span>;</div><div class="line">                        <span class="keyword">if</span> (prevMsg != <span class="keyword">null</span>) &#123;</div><div class="line">                            prevMsg.next = msg.next;</div><div class="line">                        &#125; <span class="keyword">else</span> &#123;</div><div class="line">                            mMessages = msg.next;</div><div class="line">                        &#125;</div><div class="line">                        msg.next = <span class="keyword">null</span>;</div><div class="line">                        <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">"Returning message: "</span> + msg);</div><div class="line">                        msg.markInUse();</div><div class="line">                        <span class="keyword">return</span> msg;</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    nextPollTimeoutMillis = -<span class="number">1</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (mQuitting) &#123;</div><div class="line">                    dispose();</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (pendingIdleHandlerCount &lt; <span class="number">0</span></div><div class="line">                        &amp;&amp; (mMessages == <span class="keyword">null</span> || now &lt; mMessages.when)) &#123;</div><div class="line">                    pendingIdleHandlerCount = mIdleHandlers.size();</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (pendingIdleHandlerCount &lt;= <span class="number">0</span>) &#123;</div><div class="line">                    mBlocked = <span class="keyword">true</span>;</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (mPendingIdleHandlers == <span class="keyword">null</span>) &#123;</div><div class="line">                    mPendingIdleHandlers = <span class="keyword">new</span> IdleHandler[Math.max(pendingIdleHandlerCount, <span class="number">4</span>)];</div><div class="line">                &#125;</div><div class="line">                mPendingIdleHandlers = mIdleHandlers.toArray(mPendingIdleHandlers);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pendingIdleHandlerCount; i++) &#123;</div><div class="line">                <span class="keyword">final</span> IdleHandler idler = mPendingIdleHandlers[i];</div><div class="line">                mPendingIdleHandlers[i] = <span class="keyword">null</span>; <span class="comment">// release the reference to the handler</span></div><div class="line"></div><div class="line">                <span class="keyword">boolean</span> keep = <span class="keyword">false</span>;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    keep = idler.queueIdle();</div><div class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                    Log.wtf(TAG, <span class="string">"IdleHandler threw exception"</span>, t);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (!keep) &#123;</div><div class="line">                    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">                        mIdleHandlers.remove(idler);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            pendingIdleHandlerCount = <span class="number">0</span>;</div><div class="line">            nextPollTimeoutMillis = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h2 id="Looper到底保存在哪里的？"><a href="#Looper到底保存在哪里的？" class="headerlink" title="Looper到底保存在哪里的？"></a>Looper到底保存在哪里的？</h2><p>一个线程一般私有三种类型的数据：</p>
<ol>
<li>栈</li>
<li>Thread Local Storage </li>
<li>寄存器</li>
</ol>
<p>在一个线程调用<code>Looper.prepare()</code>后，会实例化一个Looper对象，保存在Thread Local Storage中。 Handler可以从TLS中获得Looper的引用，这样就可以把Thread和Looper形成一一对应的关系</p>
<h2 id="Handler如何循环？"><a href="#Handler如何循环？" class="headerlink" title="Handler如何循环？"></a>Handler如何循环？</h2><p>调用Looper.loop( )后，会进入一个永真循环，去调用queue.next( )</p>
<p>而queue.next( )又是一个永真循环，不断查询是否有新的消息</p>
<h2 id="循环在什么时候退出？"><a href="#循环在什么时候退出？" class="headerlink" title="循环在什么时候退出？"></a>循环在什么时候退出？</h2><p>对于<code>Looper.loop()</code>中的循环，当且仅当<code>queue.next()</code>返回null时退出<br>对于<code>queue.next()</code>中的循环，当且仅当mQuitting为真时退出</p>
<p><code>queue.next()</code>什么时候会返回null呢？</p>
<p>查看源码我们发现有两处<code>return null</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (ptr == <span class="number">0</span>) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (mQuitting) &#123;</div><div class="line">    dispose();</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>对于第一处：<br>当一个线程的Looper已经退出，并且所有的消息都处理了，如果再重启这个Looper，就会使得<code>ptr==0</code>为真<br>意思就是一个线程处理了所有事件，手动退出Looper。以后就算再重新调用<code>Looper.loop()</code>，也是不能正常收到事件的</p>
<p>对于第二处：<br>当mQuitting为真会进入该段代码</p>
<p>那什么情况下mQuitting会为真呢</p>
<p>在Looper.quit( ):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">quit</span><span class="params">()</span> </span>&#123;</div><div class="line">    mQueue.quit(<span class="keyword">false</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>MessageQueue.quit():</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">quit</span><span class="params">(<span class="keyword">boolean</span> safe)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!mQuitAllowed) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Main thread not allowed to quit."</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (mQuitting) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        mQuitting = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (safe) &#123;</div><div class="line">            removeAllFutureMessagesLocked();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            removeAllMessagesLocked();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// We can assume mPtr != 0 because mQuitting was previously false.</span></div><div class="line">        nativeWake(mPtr);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以发现，当且仅当我们调用了<code>MessageQueue.quit()</code>，<code>mQuitting</code>为真，<code>MessageQueue.next()</code>返回null，跳出循环，进而调到<code>next()</code>方法的<code>Looper.loop()</code>方法也跳出循环</p>
<p>也就是说，只有我们调用了Looper.quit()后，循环才会停止</p>
<p>同时我们注意到了<code>throw new IllegalStateException(&quot;Main thread not allowed to quit.&quot;);</code>这个异常，也就是说我们不可能主动退出主线程的Looper，不能手动停止主线程的消息循环</p>
<h2 id="主线程的Handler在哪实例化的？Looper又在哪里调用prepare-和loop-的？"><a href="#主线程的Handler在哪实例化的？Looper又在哪里调用prepare-和loop-的？" class="headerlink" title="主线程的Handler在哪实例化的？Looper又在哪里调用prepare( )和loop( )的？"></a>主线程的Handler在哪实例化的？Looper又在哪里调用prepare( )和loop( )的？</h2><p>在ActivityThread中有以下代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"ActivityThreadMain"</span>);</div><div class="line">    SamplingProfilerIntegration.start();</div><div class="line">    CloseGuard.setEnabled(<span class="keyword">false</span>);</div><div class="line">    Environment.initForCurrentUser();</div><div class="line">    EventLogger.setReporter(<span class="keyword">new</span> EventLoggingReporter());</div><div class="line">    <span class="keyword">final</span> File configDir = Environment.getUserConfigDirectory(UserHandle.myUserId());</div><div class="line">    TrustedCertificateStore.setDefaultUserDirectory(configDir);</div><div class="line">    Process.setArgV0(<span class="string">"&lt;pre-initialized&gt;"</span>);</div><div class="line">    <span class="comment">//准备主线程的Looper</span></div><div class="line">    Looper.prepareMainLooper();</div><div class="line">    ActivityThread thread = <span class="keyword">new</span> ActivityThread();</div><div class="line">    <span class="comment">//创建ApplicationThread，即开启Binder，接收AMS消息</span></div><div class="line">    thread.attach(<span class="keyword">false</span>);</div><div class="line">    <span class="comment">//实例化Handler，此Handler接收ApplicationThread的消息</span></div><div class="line">    <span class="keyword">if</span> (sMainThreadHandler == <span class="keyword">null</span>) &#123;</div><div class="line">        sMainThreadHandler = thread.getHandler();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</div><div class="line">        Looper.myLooper().setMessageLogging(<span class="keyword">new</span></div><div class="line">                LogPrinter(Log.DEBUG, <span class="string">"ActivityThread"</span>));</div><div class="line">    &#125;</div><div class="line">    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</div><div class="line">    <span class="comment">//Looper.loop( )</span></div><div class="line">    Looper.loop();</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Main thread loop unexpectedly exited"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看见我们调用<code>Looper.prepareMainLooper()</code>来准备我们主线程的Looper<br>该方法会检查主线程的Looper是否已经创建过了，如果创建过了，就抛出异常<br>并且设置主线程的Looper是不允许退出的，而且，只有主线程的Looper能够有此殊荣</p>
<p>主线程的Handler类名叫H，是ActivityThread类的内部类</p>
<p><code>handleMessage(Message msg)</code>方法负责分发事件，这个方法在<code>ApplicationThread</code>被<code>sendMessage()</code>方法调用，<code>ApplicationThread</code>继承自<code>Binder</code>，接收来自AMS的IPC消息</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/04/18/Android消息机制自问自答/" data-id="cj1psth820000fliq25ez0mja" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-讲义（三）" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/04/14/讲义（三）/" class="article-date">
  <time datetime="2017-04-14T12:00:00.000Z" itemprop="datePublished">2017-04-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android/">Android</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/14/讲义（三）/">讲义（三）</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="http://123.207.31.42/web/lesson3/Lesson3.html" target="_blank" rel="external">View事件</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/04/14/讲义（三）/" data-id="cj1psth8m000gfliq2li5znkv" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-讲义（二）" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/20/讲义（二）/" class="article-date">
  <time datetime="2017-03-20T08:30:00.000Z" itemprop="datePublished">2017-03-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android/">Android</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/20/讲义（二）/">讲义（二）</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="http://123.207.31.42/web/lesson2/lesson2.html" target="_blank" rel="external">View基础</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/03/20/讲义（二）/" data-id="cj1psth8n000ifliqu1p3phwr" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-讲义（一） " class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/18/讲义（一） /" class="article-date">
  <time datetime="2017-03-18T12:52:00.000Z" itemprop="datePublished">2017-03-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android/">Android</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/18/讲义（一） /">讲义（一）</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="http://123.207.31.42/web/lesson1.html" target="_blank" rel="external">自定义View</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/03/18/讲义（一） /" data-id="cj1psth8l000efliqfwmaiu4l" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-JS学习" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/20/JS学习/" class="article-date">
  <time datetime="2017-01-20T13:30:00.000Z" itemprop="datePublished">2017-01-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/20/JS学习/">前端学习记录（ 一 ）</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="HTML"><a href="#HTML" class="headerlink" title="HTML"></a>HTML</h2><ul>
<li>硬编码 - 直接写在HTML中</li>
<li>软编码 - HTML模板+JS</li>
</ul>
<h2 id="JS-基础"><a href="#JS-基础" class="headerlink" title="JS 基础"></a>JS 基础</h2><h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><p>var {varName} = {Value};</p>
<h3 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h3><p>可以以下标 + 数组的方式访问串中的每个char</p>
<p>模式替换 string.replace( [ old ], [ new ] );</p>
<p>剪切 string.slice();</p>
<p>…</p>
<h3 id="布尔值"><a href="#布尔值" class="headerlink" title="布尔值"></a>布尔值</h3><table>
<thead>
<tr>
<th>true</th>
<th>false</th>
</tr>
</thead>
<tbody>
<tr>
<td>true</td>
<td>false</td>
</tr>
<tr>
<td>non-zero</td>
<td>0</td>
</tr>
<tr>
<td>“string”</td>
<td>“”</td>
</tr>
<tr>
<td>objects</td>
<td>undefined</td>
</tr>
<tr>
<td>arrays</td>
<td>null</td>
</tr>
<tr>
<td>functions</td>
<td>NaN</td>
</tr>
</tbody>
</table>
<h3 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h3><p>定义： var array = [ 0,1,2 ,”string”,object,];</p>
<p>类型可以混合在一起</p>
<p>log: 顺序输出</p>
<p>数组操作： pop( ) push( ) 类似栈的操作</p>
<h3 id="对象"><a href="#对象" class="headerlink" title="对象"></a>对象</h3><p>JS 没有类。。。WTF？</p>
<p>但是可以 new 对象😳😳😳</p>
<p>或者：<br>var obj = {<br>    “name” : “simonla”,<br>    “age” : 21<br> } ;</p>
<p> 这种方式叫做对象字面量（Object Literals），喵的不就是JSON嘛</p>
<p> 访问：</p>
<ul>
<li>obj. name ===&gt; simonla</li>
<li><p>obj[ “name” ] ===&gt; simonla</p>
<blockquote>
<p>Functions are first class objects in javascript!</p>
</blockquote>
</li>
</ul>
<p>BTW，在JS中，函数也是对象</p>
<h3 id="循环与迭代"><a href="#循环与迭代" class="headerlink" title="循环与迭代"></a>循环与迭代</h3><h4 id="for-in-循环"><a href="#for-in-循环" class="headerlink" title="for - in 循环"></a>for - in 循环</h4><p>for ( index in array )</p>
<p>index 是 array 的索引</p>
<p>更建议使用 for - each 循环</p>
<h4 id="for-each-循环"><a href="#for-each-循环" class="headerlink" title="for - each 循环"></a>for - each 循环</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">var a = [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;];</div><div class="line"></div><div class="line">a.forEach(function(element) &#123;</div><div class="line">    console.log(element);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h3><p>两种方式 ：</p>
<ul>
<li><p>var myFunc = function( … ) {<br>  //doSomeThings<br>}</p>
</li>
<li><p>function myFunc( … ) {<br>  //doSomeThings<br>}</p>
</li>
</ul>
<h2 id="JQuery基础"><a href="#JQuery基础" class="headerlink" title="JQuery基础"></a>JQuery基础</h2><h3 id="为什么要有JQuery"><a href="#为什么要有JQuery" class="headerlink" title="为什么要有JQuery?"></a>为什么要有JQuery?</h3><p>纯JS操作DOM并不方便</p>
<h3 id="JQuery过时了吗"><a href="#JQuery过时了吗" class="headerlink" title="JQuery过时了吗?"></a>JQuery过时了吗?</h3><p>已然过时</p>
<h3 id=""><a href="#" class="headerlink" title="$"></a>$</h3><p>$( ). &lt;==&gt; jQuery( ).</p>
<h3 id="导入"><a href="#导入" class="headerlink" title="导入"></a>导入</h3><p>从本地</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;script src=&quot;js/jquery.min.js&gt;&lt;/script&gt;</div></pre></td></tr></table></figure>
<p>或者从其他的CDN</p>
<h3 id="替换-DOM"><a href="#替换-DOM" class="headerlink" title="替换 DOM"></a>替换 DOM</h3><p>$( “CSS”  ).html( DOM );</p>
<h3 id="添加-DOM"><a href="#添加-DOM" class="headerlink" title="添加 DOM"></a>添加 DOM</h3><p>$( “CSS” ).append( “xxx” ) 在子元素最后</p>
<p>prepend() 方法是在子元素最前添加</p>
<h3 id="访问DOM"><a href="#访问DOM" class="headerlink" title="访问DOM"></a>访问DOM</h3><ul>
<li><p>$( “tag” )</p>
</li>
<li><p>$( “.class” )</p>
</li>
<li><p>$( “#id” )</p>
</li>
</ul>
<p>和CSS选择器没什么差别</p>
<p>因为DOM是树结构</p>
<p>jQuery提供了树的接口:</p>
<p>$( “selector” ).parent( ).parents( ).children( ).find( ).sibings( )</p>
<h3 id="toggleClass"><a href="#toggleClass" class="headerlink" title=".toggleClass()"></a>.toggleClass()</h3><p>如果没有这个 class，就加上</p>
<p>否则，就去掉这个 class</p>
<p>传入类名，而不是选择器，前面没有那个英文句号</p>
<h3 id="attr-amp-css"><a href="#attr-amp-css" class="headerlink" title=".attr( ) &amp; .css( )"></a>.attr( ) &amp; .css( )</h3><p>用于修改DOM样式 </p>
<p>区别：attr可以修改html标签上展示为xxx=””任意属性值，css只能修改属性名为style的值，也就是style=””里面的值</p>
<h3 id="获得html"><a href="#获得html" class="headerlink" title="获得html"></a>获得html</h3><p>.html( ): 获得完整的 html</p>
<p>.text( ): 获得 tag 之间的内容</p>
<h3 id="获得表单值"><a href="#获得表单值" class="headerlink" title="获得表单值"></a>获得表单值</h3><p>.val( )</p>
<h3 id="删除DOM"><a href="#删除DOM" class="headerlink" title="删除DOM"></a>删除DOM</h3><p>remove( );</p>
<h3 id="一边看文档，一边在这里记录一下，但是已经没有必要了，有了这些基础的东西，其他的再查文档就行了"><a href="#一边看文档，一边在这里记录一下，但是已经没有必要了，有了这些基础的东西，其他的再查文档就行了" class="headerlink" title="一边看文档，一边在这里记录一下，但是已经没有必要了，有了这些基础的东西，其他的再查文档就行了"></a>一边看文档，一边在这里记录一下，但是已经没有必要了，有了这些基础的东西，其他的再查文档就行了</h3><h2 id="JQuery-事件监听"><a href="#JQuery-事件监听" class="headerlink" title="JQuery 事件监听"></a>JQuery 事件监听</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$( selector ).on( &#123;Event&#125;, function()&#123;</div><div class="line">	//do-some-things </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>或者 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$( selector ).click(function()&#123;</div><div class="line">	//do-some-things</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="面向对象的JavaScript"><a href="#面向对象的JavaScript" class="headerlink" title="面向对象的JavaScript"></a>面向对象的JavaScript</h2><h3 id="作用域-scope"><a href="#作用域-scope" class="headerlink" title="作用域 ( scope )"></a>作用域 ( scope )</h3><h3 id="闭包-closure"><a href="#闭包-closure" class="headerlink" title="闭包( closure )"></a>闭包( closure )</h3><h3 id="this"><a href="#this" class="headerlink" title="this"></a>this</h3><h3 id="回去过寒假啦，来年继续"><a href="#回去过寒假啦，来年继续" class="headerlink" title="回去过寒假啦，来年继续~"></a>回去过寒假啦，来年继续~</h3>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/01/20/JS学习/" data-id="cj1psth8a0003fliqxrht6w5i" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-View总结" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/30/View总结/" class="article-date">
  <time datetime="2016-12-30T10:13:00.000Z" itemprop="datePublished">2016-12-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android/">Android</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/30/View总结/">View滑动相关总结</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="坐标"><a href="#坐标" class="headerlink" title="坐标"></a>坐标</h2><h3 id="View中的坐标"><a href="#View中的坐标" class="headerlink" title="View中的坐标"></a>View中的坐标</h3><table>
<thead>
<tr>
<th style="text-align:left">name</th>
<th style="text-align:left">explain</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">getLeft()</td>
<td style="text-align:left">返回View自身左边到父布局左边的距离</td>
</tr>
<tr>
<td style="text-align:left">getTop()</td>
<td style="text-align:left">返回View自身顶边到父布局顶边的距离</td>
</tr>
<tr>
<td style="text-align:left">getRight()</td>
<td style="text-align:left">返回View自身右边到父布局左边的距离</td>
</tr>
<tr>
<td style="text-align:left">getBottom()</td>
<td style="text-align:left">返回View自身到父布局 顶边的距离</td>
</tr>
<tr>
<td style="text-align:left">getX()</td>
<td style="text-align:left">返回值为getLeft()+getTranslationX()，当setTranslationX()时getLeft()不变，getX()变</td>
</tr>
<tr>
<td style="text-align:left">getY()</td>
<td style="text-align:left">返回值为getTop()+getTranslationY()，当setTranslationY()时getTop()不变，getY()变</td>
</tr>
</tbody>
</table>
<h3 id="触摸事件MotionEvent中的坐标"><a href="#触摸事件MotionEvent中的坐标" class="headerlink" title="触摸事件MotionEvent中的坐标"></a>触摸事件MotionEvent中的坐标</h3><table>
<thead>
<tr>
<th style="text-align:left">name</th>
<th style="text-align:left">explain</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">getX()</td>
<td style="text-align:left">当前View中，距离左边的距离</td>
</tr>
<tr>
<td style="text-align:left">getY()</td>
<td style="text-align:left">当前View中，距离顶边的距离</td>
</tr>
<tr>
<td style="text-align:left">getRawX()</td>
<td style="text-align:left">整个屏幕中，距离左边的距离</td>
</tr>
<tr>
<td style="text-align:left">getRawY()</td>
<td style="text-align:left">整个屏幕中，距离顶边的距离</td>
</tr>
</tbody>
</table>
<h3 id="滑动相关的坐标"><a href="#滑动相关的坐标" class="headerlink" title="滑动相关的坐标"></a>滑动相关的坐标</h3><table>
<thead>
<tr>
<th style="text-align:left">name</th>
<th style="text-align:left">explain</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">offsetLeftAndRight(int offset)</td>
<td style="text-align:left">水平方向挪动View，offset为正则x轴正向移动，移动的是整个View，getLeft()会变</td>
</tr>
<tr>
<td style="text-align:left">goffsetTopAndBottom(int offset)</td>
<td style="text-align:left">垂直方向挪动View，offset为正则y轴正向移动，移动的是整个View，getTop()会变</td>
</tr>
<tr>
<td style="text-align:left">scrollTo(int x, int y)</td>
<td style="text-align:left">将View中内容滑动到相应的位置，参考坐标原点为ParentView左上角，x,y为正则向x,y轴反方向移动，反之同理。</td>
</tr>
<tr>
<td style="text-align:left">scrollBy（int x, int y）</td>
<td style="text-align:left">调用scrollTo(scrollX+x,scrollY+y),也就是基于当前位置的相对滑动</td>
</tr>
<tr>
<td style="text-align:left">getScrollX()/getScrollY()</td>
<td style="text-align:left">View左边缘到View内容左边缘的距离 /View上边缘到View内容上边缘的距离</td>
</tr>
</tbody>
</table>
<h2 id="滑动（改变View的位置）"><a href="#滑动（改变View的位置）" class="headerlink" title="滑动（改变View的位置）"></a>滑动（改变View的位置）</h2><h3 id="方法一：layout"><a href="#方法一：layout" class="headerlink" title="方法一：layout"></a>方法一：layout</h3><p>调用View的layout方法，对View自身进行重新布局，来达到改变View位置的效果</p>
<p>layout(int l, int t, int r, int b), 四个参数是left, top, right, bottom </p>
<p>很简单，没什么好说的</p>
<h3 id="方法二：LayoutParams"><a href="#方法二：LayoutParams" class="headerlink" title="方法二：LayoutParams"></a>方法二：LayoutParams</h3><p>LayoutParams是子视图向父视图传达自己想要变成什么样子的一个东西</p>
<p>它是作为一个静态内部类放在不同的ViewGroup里面的</p>
<p>所以不同的ViewGroup有不同的LayoutParams，在这里我们不再展开</p>
<p>我们只需要知道，padding, margin,gravity等等都是它在控制，我们当然可以拿来移动View</p>
<p>因为LayoutParams的继承结构，我们可以用如下代码来来达到我们的目的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ViewGroup.MarginLayoutParams lp = (ViewGroup.MarginLayoutParams) 	getLayoutParams();</div><div class="line">lp.leftMargin = xxx;</div><div class="line">lp.topMargin = xxx;</div><div class="line">setLayoutParams(lp);</div></pre></td></tr></table></figure>
<h3 id="方法三：scrollTo与scrollBy"><a href="#方法三：scrollTo与scrollBy" class="headerlink" title="方法三：scrollTo与scrollBy"></a>方法三：scrollTo与scrollBy</h3><p>都是View的方法</p>
<p>对View来说是移动的View的content，对ViewGroup来说是移动的childView，后文不再加以区分，统一称为移动的View的内容</p>
<p>scrollTo(x, y)是移动到指定的地方</p>
<p>scrollBy(x, y)是移动的增量</p>
<p>scrollBy实际上也是调用的scrollTo</p>
<p>通过源码可以发现，参数(x, y)，实际上是改变了View的mScrollX和mScrollY，在这里解释一下这两个值</p>
<p>mScrollX: View左边缘到View内容左边缘的距离</p>
<p>mScrollY: View上边缘到View内容上边缘的距离</p>
<h3 id="方法四：Scroller"><a href="#方法四：Scroller" class="headerlink" title="方法四：Scroller"></a>方法四：Scroller</h3><p>其实我觉得像是一个工具类，它能为我们把一次滑动，分成很多次小滑动，方便我们实现弹性滑动</p>
<p>为什么说Scroller更像是一个工具类，因为Scroller并不会对View进行任何操作，它只会保存，然后计算出一组数值</p>
<p>这个类代码也不多，有兴趣可以读一下</p>
<h4 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mScroller = <span class="keyword">new</span> Scroller(context);</div></pre></td></tr></table></figure>
<p>或者设置一个插值器</p>
<p>默认设置了一个ViscousFluidInterpolator()的插值器</p>
<h4 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mScroller.startScroll(<span class="keyword">int</span> startX, <span class="keyword">int</span> startY, <span class="keyword">int</span> dx, <span class="keyword">int</span> dy, <span class="keyword">int</span> duration)</div></pre></td></tr></table></figure>
<p>或者设置一下时长，默认为250ms</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mScroller.startScroll(<span class="keyword">int</span> startX, <span class="keyword">int</span> startY, <span class="keyword">int</span> dx, <span class="keyword">int</span> dy)</div></pre></td></tr></table></figure>
<p>前两个参数是起始坐标，后两个是偏移量</p>
<h4 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h4><p>我们调用了startScroll以后，再调用一次View的invalidate()方法，对View进行重绘制</p>
<p>这时View的Draw()方法会调用 computeScroll()方法，可以看见，在View中该方法没有任何实现，我们复写它</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">computeScroll</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.computeScroll();</div><div class="line">    <span class="keyword">if</span> (mScroller.computeScrollOffset()) &#123;</div><div class="line">      	<span class="comment">//你要进行的操作</span></div><div class="line">        invalidate();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>mScroller.computeScrollOffset()将会通知你是否已经完成了上一次滑动，否则在方法中的 invalidate()将会反复被调用，陷入无限循环</p>
<p>如果该方法返回true，成功进入条件语句</p>
<p>Scroller为我们提供了mScroller.getCurrX(), mScroller.getCurrY()</p>
<p>我们把Scroller提供的值传给scrollBy() / scrollTo()，来实现我们想要的滑动</p>
<p>最后，再调用一次invalidate()，来循环上述操作</p>
<h4 id="方法五：动画"><a href="#方法五：动画" class="headerlink" title="方法五：动画"></a>方法五：动画</h4><p>主要是通过属性动画，举个栗子</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ObjectAnimator.ofFloat(<span class="keyword">this</span>, <span class="string">"translationX"</span>, viewGroup.getScrollX()).setDuration(<span class="number">200</span>).start();</div><div class="line"></div><div class="line">ObjectAnimator.ofFloat(<span class="keyword">this</span>,<span class="string">"translationY"</span>,viewGroup.getScrollY()).setDuration(<span class="number">200</span>).start();</div></pre></td></tr></table></figure>
<p>属性动画的具体实现感觉探索起来还是很有趣的，以后有机会再写一篇，这里就暂且不说啦</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/12/30/View总结/" data-id="cj1psth8b0004fliqevhgn53v" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-排序算法" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/03/排序算法/" class="article-date">
  <time datetime="2016-12-03T05:08:00.000Z" itemprop="datePublished">2016-12-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Algorithms/">Algorithms</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/03/排序算法/">常见排序算法</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="常见排序算法横测😂"><a href="#常见排序算法横测😂" class="headerlink" title="常见排序算法横测😂"></a>常见排序算法横测😂</h2><p>主要选手有</p>
<ul>
<li>冒泡排序</li>
<li>选择排序</li>
<li>插入排序</li>
<li>希尔排序</li>
<li>归并排序</li>
<li>快速排序</li>
</ul>
<p>为了比较各种选手的实力，特别增加了他们的爸爸，也就是Sort基类，封装了一些常用的操作，方便我们进行比较</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Sort</span> </span>&#123;</div><div class="line">    Integer[] mInts;</div><div class="line">    <span class="keyword">int</span> mLen;</div><div class="line"></div><div class="line">    Sort(Integer[] ints) &#123;</div><div class="line">        mInts = ints;</div><div class="line">        mLen = mInts.length;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 返回数组</div><div class="line">     * <span class="doctag">@return</span> 数组</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> Integer[] getInts() &#123;</div><div class="line">        <span class="keyword">return</span> mInts;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">long</span> <span class="title">sort</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 打印出排序后的数组</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">printSort</span><span class="params">()</span> </span>&#123;</div><div class="line">        sort();</div><div class="line">        <span class="keyword">for</span> (Integer i : mInts) &#123;</div><div class="line">            System.out.println(<span class="keyword">this</span>.getClass().getName() + <span class="string">" ==&gt; "</span> + i);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 按秩交换原数组的两个元素</div><div class="line">     * <span class="doctag">@param</span> i 第一个待交换元素的秩</div><div class="line">     * <span class="doctag">@param</span> j 第二个待交换元素的秩</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">swap</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</div><div class="line">        Integer t = mInts[i];</div><div class="line">        mInts[i] = mInts[j];</div><div class="line">        mInts[j] = t;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 前一个元素是否小于后一个元素</div><div class="line">     * <span class="doctag">@param</span> i 前一个元素</div><div class="line">     * <span class="doctag">@param</span> j 后一个元素</div><div class="line">     * <span class="doctag">@return</span> 真为小于</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">less</span><span class="params">(Integer i, Integer j)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span>  i.compareTo(j)&lt;<span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 可以优化到 O(logN)</div><div class="line">     * 以输入为界桩，向后找到最小的元素</div><div class="line">     * <span class="doctag">@param</span> i 界桩的秩</div><div class="line">     * <span class="doctag">@return</span> 返回最小元素的秩</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">min</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> min = i;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = i + <span class="number">1</span>; j &lt; mLen; j++) &#123;</div><div class="line">            <span class="keyword">if</span> (less(j, min)) min = j;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> min;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 搜索特定元素的</div><div class="line">     * <span class="doctag">@param</span> lo 左界桩的秩</div><div class="line">     * <span class="doctag">@param</span> hi 右界桩的秩</div><div class="line">     * <span class="doctag">@param</span> target 待寻找元素的秩</div><div class="line">     * <span class="doctag">@return</span> 如果命中，返回靶的秩，如果没有，返回右界桩的秩</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">search</span><span class="params">(<span class="keyword">int</span> lo, <span class="keyword">int</span> hi, <span class="keyword">int</span> target)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = lo; i &lt; hi; i++) &#123;</div><div class="line">            <span class="keyword">if</span> (mInts[i] &gt; target) <span class="keyword">return</span> i;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> hi;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 简单的检查是否已经排序</div><div class="line">     * <span class="doctag">@return</span> 是否有序</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">check</span><span class="params">()</span> </span>&#123;</div><div class="line">        sort();</div><div class="line">        <span class="keyword">boolean</span> flag = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">if</span> (mLen != mInts.length) <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mLen - <span class="number">1</span>; i++) &#123;</div><div class="line">            <span class="keyword">if</span> (less(mInts[i + <span class="number">1</span>], mInts[i])) &#123;</div><div class="line">                flag = <span class="keyword">false</span>;</div><div class="line">                System.out.println(<span class="keyword">this</span>.getClass().getName() + <span class="string">" "</span> + mInts[i] + <span class="string">" - "</span> + mInts[i + <span class="number">1</span>] + <span class="string">" = "</span> + ((mInts[i]) - (mInts[i + <span class="number">1</span>])));</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> flag;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 置乱器，增大元素的混乱程度</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">unSort</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = mLen ; i &gt; <span class="number">0</span>; i--) &#123;</div><div class="line">            swap(i - <span class="number">1</span>, <span class="keyword">new</span> Random().nextInt(mLen) % i);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 指定范围内向后移动一个单位</div><div class="line">     * <span class="doctag">@param</span> lo 左边界，闭区间</div><div class="line">     * <span class="doctag">@param</span> hi 右边界，闭区间</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">moveOneStep</span><span class="params">(<span class="keyword">int</span> lo, <span class="keyword">int</span> hi)</span> </span>&#123;</div><div class="line">        System.arraycopy(mInts, lo, mInts, lo + <span class="number">1</span>, hi + <span class="number">1</span> - lo);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="测试类"><a href="#测试类" class="headerlink" title="测试类"></a>测试类</h2><p>因为有些排序算法是输入敏感类型，为了测试算法的稳定性等，特别添加以下功能</p>
<ul>
<li>生成均匀分布的随机数组</li>
<li>生成顺序排布的随机数组</li>
<li>生成元素重复的数组</li>
<li>按线程分别排序，性能优劣一目了然</li>
<li>自动检测排序结果的正确性</li>
<li>算出各种排序算法相对基准时间的比值</li>
<li>因为有些算法实在是太慢，所以分为低分段和高分段分别测试</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SortTest</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TEST_SCALE = <span class="number">1000000</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MODE_THREAD = <span class="number">0</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MODE_DEFAULT = <span class="number">1</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MODE_CHECK = <span class="number">2</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MODE_FAST_GROUP = <span class="number">3</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Integer[] mInts = <span class="keyword">new</span> Integer[TEST_SCALE];</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        mInts = getRandomArr();</div><div class="line">        <span class="keyword">new</span> Thread(() -&gt; doTest(MODE_FAST_GROUP)).start();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">doTest</span><span class="params">(<span class="keyword">int</span> mode)</span> </span>&#123;</div><div class="line">        BubbleSort bubbleSort = <span class="keyword">new</span> BubbleSort(mInts);</div><div class="line">        MergeSort mergeSort = <span class="keyword">new</span> MergeSort(mInts);</div><div class="line">        SelectionSort selectionSort = <span class="keyword">new</span> SelectionSort(mInts);</div><div class="line">        InsertionSort insertionSort = <span class="keyword">new</span> InsertionSort(mInts);</div><div class="line">        ShellSort shellSort = <span class="keyword">new</span> ShellSort(mInts);</div><div class="line">        QuickSort quickSort = <span class="keyword">new</span> QuickSort(mInts);</div><div class="line"></div><div class="line">        <span class="keyword">switch</span> (mode) &#123;</div><div class="line">            <span class="keyword">case</span> MODE_CHECK:</div><div class="line">                System.out.println(bubbleSort.getClass().getName() + <span class="string">" ==&gt; "</span> + bubbleSort.check());</div><div class="line">                System.out.println(mergeSort.getClass().getName() + <span class="string">" ==&gt; "</span> + mergeSort.check());</div><div class="line">                System.out.println(selectionSort.getClass().getName() + <span class="string">" ==&gt; "</span> + selectionSort.check());</div><div class="line">                System.out.println(insertionSort.getClass().getName() + <span class="string">" ==&gt; "</span> + insertionSort.check());</div><div class="line">                System.out.println(shellSort.getClass().getName() + <span class="string">" ==&gt; "</span> + shellSort.check());</div><div class="line">                System.out.println(quickSort.check());</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> MODE_THREAD:</div><div class="line">                <span class="keyword">new</span> Thread(() -&gt; printTime(bubbleSort)).start();</div><div class="line">                <span class="keyword">new</span> Thread(() -&gt; printTime(mergeSort)).start();</div><div class="line">                <span class="keyword">new</span> Thread(() -&gt; printTime(selectionSort)).start();</div><div class="line">                <span class="keyword">new</span> Thread(() -&gt; printTime(insertionSort)).start();</div><div class="line">                <span class="keyword">new</span> Thread(() -&gt; printTime(shellSort)).start();</div><div class="line">                <span class="keyword">new</span> Thread(() -&gt; printTime(quickSort)).start();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> MODE_DEFAULT:</div><div class="line">                <span class="keyword">long</span> bubbleSortTime = bubbleSort.sort();</div><div class="line">                <span class="keyword">new</span> Thread(() -&gt; printMultiple(mergeSort, bubbleSortTime)).start();</div><div class="line">                <span class="keyword">new</span> Thread(() -&gt; printMultiple(insertionSort, bubbleSortTime)).start();</div><div class="line">                <span class="keyword">new</span> Thread(() -&gt; printMultiple(selectionSort, bubbleSortTime)).start();</div><div class="line">                <span class="keyword">new</span> Thread(() -&gt; printMultiple(shellSort, bubbleSortTime)).start();</div><div class="line">                <span class="keyword">new</span> Thread(() -&gt; printMultiple(quickSort, bubbleSortTime)).start();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> MODE_FAST_GROUP:</div><div class="line">                printTime(quickSort);</div><div class="line">                printTime(mergeSort);</div><div class="line">                printTime(shellSort);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printTime</span><span class="params">(Sort sort)</span> </span>&#123;</div><div class="line">        System.out.println(sort.getClass().getName() + <span class="string">" ==&gt; "</span> + sort.sort() + <span class="string">" ms"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printMultiple</span><span class="params">(Sort sort, <span class="keyword">long</span> index)</span> </span>&#123;</div><div class="line">        <span class="keyword">long</span> comp = sort.sort();</div><div class="line">        <span class="keyword">if</span> (comp == <span class="number">0</span>) &#123;</div><div class="line">            System.out.println(sort.getClass().getName() + <span class="string">" is too fast"</span>);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">double</span> multiple = index / comp;</div><div class="line">        System.out.println(sort.getClass().getName() + <span class="string">" "</span> + multiple + <span class="string">"X faster than bubble"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Integer[] getRandomArr() &#123;</div><div class="line">        Integer[] arr = <span class="keyword">new</span> Integer[TEST_SCALE];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; TEST_SCALE; arr[i++] = <span class="keyword">new</span> Random().nextInt()) ;</div><div class="line">        <span class="keyword">return</span> arr;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Integer[] getSortedArr() &#123;</div><div class="line">        Integer[] arr = <span class="keyword">new</span> Integer[TEST_SCALE];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; TEST_SCALE; arr[i++] = i) ;</div><div class="line">        <span class="keyword">return</span> arr;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Integer[] getRepetitiveArr() &#123;</div><div class="line">        Integer[] arr = <span class="keyword">new</span> Integer[TEST_SCALE];</div><div class="line">        <span class="keyword">int</span> a = <span class="keyword">new</span> Random().nextInt();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; TEST_SCALE; i++) &#123;</div><div class="line">            arr[i] = a;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> arr;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="冒泡排序和选择排序"><a href="#冒泡排序和选择排序" class="headerlink" title="冒泡排序和选择排序"></a>冒泡排序和选择排序</h2><p>这俩没啥好说的，是所有选手里面最慢的，先以10000个随机分布的数组，跑个分试试</p>
<p><img src="http://bihu-face.image.alimmdn.com/1.png?t=1480593037583" alt="图一"></p>
<p>嗨呀好气啊，理论上应该和冒泡排序差不多，为什么选择排序比冒泡排序还慢？</p>
<p>在这里大可不必怀疑我们的结果，好在误差还是在常系数范围内，并且都通过了我们的check功能的检测</p>
<p>很自然的，我们就会去想，这俩货有什么差别？</p>
<p><strong>选择排序</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mLen; i++) &#123;</div><div class="line">	<span class="comment">//Sort基类封装了 swap 和 min 操作</span></div><div class="line">	swap(i, min(i)); </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>冒泡排序</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mLen - <span class="number">1</span>; i++) &#123;</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; mLen - <span class="number">1</span> - i; j++) &#123;</div><div class="line">	<span class="comment">//Sort基类封装了 less 操作</span></div><div class="line">    <span class="keyword">if</span> (less(mInts[j + <span class="number">1</span>], mInts[j]))</div><div class="line">    swap(j, j + <span class="number">1</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到，他们都是O(n^2)，但是选择排序的交换操作会比冒泡少，而且选择排序是就地算法，不需要额外辅助空间，这大概是它唯二的两个优点了吧</p>
<p>至于之前我们的疑问：<strong><em>我们知道，交换操作消耗的时间比比较消耗的时间更多，为什么选择排序的时间会比冒泡还长？</em></strong></p>
<p>答案是，<strong><em>交换操作消耗的时间比比较消耗的时间更多这个常识</em></strong>，在java上本身就是错的，<strong>因为Java中只是改变了引用位置，而实际对象的位置并没有发生改变</strong>，这点和C/C++不一样！</p>
<h2 id="插入排序和希尔排序"><a href="#插入排序和希尔排序" class="headerlink" title="插入排序和希尔排序"></a>插入排序和希尔排序</h2><p>希尔排序是插入排序的改进版本，而且很神奇的是，一点小小的改进，竟然速度有了如此巨大的提升</p>
<p><img src="http://bihu-face.image.alimmdn.com/2.png?t=1480593037592" alt="图二 基于100000次均匀排布随机数组"></p>
<p>相比冒泡和选择在常系数上的差别，插入和希尔发生了阶上的改变</p>
<p>因为插入排序只会亦步亦趋的去交换相邻的元素，而希尔排序，会一次性将待排元素移动一大步</p>
<p><strong>插入排序</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; mLen; i++) &#123;</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> j = i; j &gt; <span class="number">0</span> &amp;&amp; less(mInts[j], mInts[j-<span class="number">1</span>]); j--)&#123;</div><div class="line">		swap(j, j-<span class="number">1</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line">``` </div><div class="line"></div><div class="line"></div><div class="line">**改进后的插入排序**</div><div class="line"></div><div class="line">```<span class="function">java</span></div><div class="line"><span class="title">for</span> <span class="params">(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; mLen; i++)</span> &#123;</div><div class="line">	<span class="keyword">if</span>(less(mInts[i-<span class="number">1</span>],mInts[i])) <span class="keyword">continue</span>;</div><div class="line">	<span class="keyword">int</span> target = mInts[i];</div><div class="line">	<span class="comment">//基类中的search和moveOneStep操作</span></div><div class="line">	<span class="keyword">int</span> result = search(<span class="number">0</span>, i-<span class="number">1</span>, target);</div><div class="line">	moveOneStep(result, i-<span class="number">1</span>);</div><div class="line">    mInts[result] = target;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="http://bihu-face.image.alimmdn.com/3.png?t=1480593037585" alt="图三，100000，改进前"><br><img src="http://bihu-face.image.alimmdn.com/4.png?t=1480593037583" alt="图四，100000，改进后"></p>
<p>改进后，我们在内循环中，将较大的元素都向后移动一位，而不是去交换他们，这样讲数组的访问次数就减半了，这和我们实际的测试数据也相当吻合</p>
<p>可以看到，虽然只是常系数的改变，但是对我们来说这已经足够欣慰，必经我们的代码并没有增加太多，但是更令人欣慰的是希尔排序☺️</p>
<p><strong>希尔排序</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//步长h</span></div><div class="line"><span class="keyword">int</span> h = <span class="number">1</span>;</div><div class="line"><span class="keyword">while</span> (h &lt; mLen / <span class="number">3</span>) h = <span class="number">3</span> * h + <span class="number">1</span>;</div><div class="line"><span class="keyword">while</span> (h &gt;= <span class="number">1</span>) &#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = h; i &lt; mLen; i++)  </div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = i; j &gt;= h &amp;&amp; less(mInts[j], mInts[j - h]); j -= h)</div><div class="line">                swap(j, j - h);</div><div class="line">        h = h / <span class="number">3</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>值得一提的是，希尔排序的具体运行速度，取决于我们选择的递减数列，也就是影响了我们上诉代码中的步长h，有兴趣的话，你可以换成不同的递减数列，来比较他们的性能</p>
<p><strong>输入敏感</strong></p>
<p>这俩货都是输入敏感的算法，换句话说，如果输入的数组本身就具有相当的局部有序性，他们都能够立即发现，速度大幅提高</p>
<p><img src="http://bihu-face.image.alimmdn.com/5.png?t=1480593037573" alt="基于10000次顺序数组"></p>
<p>连快排也被斩落马下😂</p>
<h2 id="归并排序和快速排序"><a href="#归并排序和快速排序" class="headerlink" title="归并排序和快速排序"></a>归并排序和快速排序</h2><p>这俩货都是把分治用到极致的算法，直接上代码</p>
<p><strong>归并排序</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">mergeSort</span><span class="params">(<span class="keyword">int</span> lo, <span class="keyword">int</span> hi)</span> </span>&#123;</div><div class="line">    <span class="comment">//到达递归基，不能再分了</span></div><div class="line">    <span class="keyword">if</span> (hi == lo) <span class="keyword">return</span>;</div><div class="line">    <span class="keyword">int</span> mi = (lo + hi) &gt;&gt; <span class="number">1</span>;</div><div class="line">    mergeSort(lo, mi);</div><div class="line">    mergeSort(mi + <span class="number">1</span>, hi);</div><div class="line">    <span class="comment">//对已经有序的数组，讲时间优化到常数级别，</span></div><div class="line">    <span class="comment">//而且，测试发现，对均匀分布的随机数来说，性能也有能够优化常系数(因为输入敏感，可能对稳定性有影响）</span></div><div class="line">    <span class="keyword">if</span> (mInts[mi] &lt;= mInts[mi + <span class="number">1</span>]) <span class="keyword">return</span>;</div><div class="line">    <span class="comment">//对小数组用插入排序计算来进行优化</span></div><div class="line">    <span class="keyword">if</span> (hi - lo &lt; mLen / <span class="number">50</span>) &#123;</div><div class="line">        insertionSort(lo, hi);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        merge(lo, mi, hi);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">insertionSort</span><span class="params">(<span class="keyword">int</span> lo, <span class="keyword">int</span> hi)</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = lo + <span class="number">1</span>; i &lt;= hi; i++) &#123;</div><div class="line">        <span class="keyword">if</span> (less(mInts[i - <span class="number">1</span>], mInts[i])) <span class="keyword">continue</span>;</div><div class="line">        <span class="keyword">int</span> target = mInts[i];</div><div class="line">        <span class="keyword">int</span> result = search(lo, i - <span class="number">1</span>, target);</div><div class="line">        moveOneStep(result, i - <span class="number">1</span>);</div><div class="line">        mInts[result] = target;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">merge</span><span class="params">(<span class="keyword">int</span> lo, <span class="keyword">int</span> mi, <span class="keyword">int</span> hi)</span> </span>&#123;</div><div class="line">    <span class="comment">//mInts = B + C,即左半边 + 右半边</span></div><div class="line">    <span class="keyword">int</span> B = lo, C = mi + <span class="number">1</span>;</div><div class="line">    System.arraycopy(mInts, lo, aux, lo, hi + <span class="number">1</span> - lo);</div><div class="line">    <span class="comment">//无论如何，只会执行hi-lo+1次</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> k = lo; k &lt;= hi; k++) &#123;</div><div class="line">        <span class="comment">//如果左半边用尽，就取右半边的过来</span></div><div class="line">        <span class="keyword">if</span> (B &gt; mi) mInts[k] = aux[C++];</div><div class="line">            <span class="comment">//如果右半边用尽，就取左半边的过来</span></div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (C &gt; hi) mInts[k] = aux[B++];</div><div class="line">            <span class="comment">//两边都没用尽，哪边边小就取过来</span></div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (less(aux[C], aux[B])) mInts[k] = aux[C++];</div><div class="line">        <span class="keyword">else</span> mInts[k] = aux[B++];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>快速排序</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">quickSort</span><span class="params">(<span class="keyword">int</span> lo, <span class="keyword">int</span> hi)</span> </span>&#123;</div><div class="line">    <span class="comment">//递归基，并且对小数组做了优化，感觉不到10%左右的improve</span></div><div class="line">     <span class="keyword">if</span> (hi &lt;= lo) <span class="keyword">return</span>;</div><div class="line">    <span class="comment">//if (hi - lo &lt;= 6) &#123;</span></div><div class="line">    <span class="comment">//    insertionSort(lo, hi);</span></div><div class="line">    <span class="comment">//    return;</span></div><div class="line">    <span class="comment">//&#125;</span></div><div class="line">    <span class="keyword">int</span> j = partition(lo, hi);</div><div class="line">    <span class="comment">//划分后递归调用左右两个子序</span></div><div class="line">    <span class="comment">// <span class="doctag">TODO:</span> 2016/11/29 可以发现，这里是尾递归，尝试使用迭代法(不知道编译器是否已经对尾递归做了优化)</span></div><div class="line">    quickSort(lo, j - <span class="number">1</span>);</div><div class="line">    quickSort(j + <span class="number">1</span>, hi);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// <span class="doctag">TODO:</span> 2016/11/29 快速三向切分</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">partition</span><span class="params">(<span class="keyword">int</span> lo, <span class="keyword">int</span> hi)</span> </span>&#123;</div><div class="line">    <span class="comment">//两个指针，一个从lo开始，一个从hi开始做线性扫描</span></div><div class="line">    <span class="keyword">int</span> i = lo, j = hi + <span class="number">1</span>;</div><div class="line">    <span class="comment">//划分的界桩，未做任何优化</span></div><div class="line">    Integer v = mInts[lo];</div><div class="line">    <span class="comment">//做三取样切分优化，取3为采样率，反而退化了,可能是因为数据已经很均匀了</span></div><div class="line">    <span class="comment">//Integer v = selectMid(lo, hi, 3);</span></div><div class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">        <span class="keyword">while</span> (less(mInts[++i], v)) <span class="keyword">if</span> (i == hi) <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">while</span> (less(v, mInts[--j])) <span class="keyword">if</span> (j == lo) <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">if</span> (i &gt;= j) <span class="keyword">break</span>;</div><div class="line">        swap(i, j);</div><div class="line">    &#125;</div><div class="line">    swap(lo, j);</div><div class="line">    <span class="keyword">return</span> j;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> Integer <span class="title">selectMid</span><span class="params">(<span class="keyword">int</span> lo, <span class="keyword">int</span> hi, <span class="keyword">int</span> scale)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> v = mInts[lo];</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = lo; i &lt;= hi &amp;&amp; i - lo &lt;= scale / <span class="number">2</span>; i++) &#123;</div><div class="line">        <span class="keyword">if</span> (less(mInts[i + <span class="number">1</span>], mInts[i])) v = mInts[i];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> v;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">insertionSort</span><span class="params">(<span class="keyword">int</span> lo, <span class="keyword">int</span> hi)</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = lo + <span class="number">1</span>; i &lt;= hi; i++) &#123;</div><div class="line">        <span class="keyword">if</span> (less(mInts[i - <span class="number">1</span>], mInts[i])) <span class="keyword">continue</span>;</div><div class="line">        <span class="keyword">int</span> target = mInts[i];</div><div class="line">        <span class="keyword">int</span> result = search(lo, i - <span class="number">1</span>, target);</div><div class="line">        moveOneStep(result, i - <span class="number">1</span>);</div><div class="line">        mInts[result] = target;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到，入口都是类似的递归调用<br>而且对于小数组，都用插入排序进行了优化，实测能够有20%左右的提升</p>
<p>不同在于，归并排序是简单的选择了中点来分割，而快排很有趣，是用一种划分的方法</p>
<p>如果划分的不是恰好在数组的中间，而是两侧，就会大幅降低性能，极端情况会多N次的比较<br>，所以我们采样的方法，就是一次取多个采样点，计算中位数，来提高速度(经过测试，根本没有提高！！！，原因不明。。。数学不好。。。数学好的小伙伴可以仔细想一下)</p>
<p>相比插入排序，快排也是输入敏感的，对于已经排好的数组，插入会变得更快，而快排呢，恰恰相反，速度会大幅退化，所以我们更倾向于对快排输入的数组进行一次置乱，置乱器已经集成在了基类里</p>
<p>快排还有很多有趣的东西，我还没有完全弄清楚，就不在这里献丑了😔😔😔</p>
<h2 id="数据"><a href="#数据" class="headerlink" title="数据"></a>数据</h2><p><img src="http://bihu-face.image.alimmdn.com/6.png?t=1480594935209" alt="数据"></p>
<p>可以看见，到了数据足够大的时候，插入冒泡选择太慢了，慢到没法测试</p>
<p>在这里我们的快排并未进行任何优化，所以比归并慢一些</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><table>
<thead>
<tr>
<th style="text-align:left">算法</th>
<th style="text-align:left">是否稳定</th>
<th style="text-align:left">是否为原地排序</th>
<th style="text-align:left">时间复杂度</th>
<th style="text-align:left">空间复杂度</th>
<th style="text-align:left">备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">冒泡排序</td>
<td style="text-align:left">否</td>
<td style="text-align:left">是</td>
<td style="text-align:left">N^2</td>
<td style="text-align:left">1</td>
<td style="text-align:left">最简单的排序</td>
</tr>
<tr>
<td style="text-align:left">选择排序</td>
<td style="text-align:left">否</td>
<td style="text-align:left">是</td>
<td style="text-align:left">N^2</td>
<td style="text-align:left">1</td>
<td style="text-align:left">与冒泡相比减少了交换次数</td>
</tr>
<tr>
<td style="text-align:left">插入排序</td>
<td style="text-align:left">是</td>
<td style="text-align:left">是</td>
<td style="text-align:left">N~N^2</td>
<td style="text-align:left">1</td>
<td style="text-align:left">输入敏感</td>
</tr>
<tr>
<td style="text-align:left">希尔排序</td>
<td style="text-align:left">否</td>
<td style="text-align:left">是</td>
<td style="text-align:left">取决于递减序列</td>
<td style="text-align:left">1</td>
<td style="text-align:left">输入敏感</td>
</tr>
<tr>
<td style="text-align:left">快速排序</td>
<td style="text-align:left">否</td>
<td style="text-align:left">是</td>
<td style="text-align:left">NlogN</td>
<td style="text-align:left">lgN</td>
<td style="text-align:left">效率由概率提供保障</td>
</tr>
<tr>
<td style="text-align:left">三向快速排序</td>
<td style="text-align:left">否</td>
<td style="text-align:left">是</td>
<td style="text-align:left">N~NlogN</td>
<td style="text-align:left">lgN</td>
<td style="text-align:left">与输入元素的分布情况有关</td>
</tr>
<tr>
<td style="text-align:left">归并排序</td>
<td style="text-align:left">是</td>
<td style="text-align:left">否</td>
<td style="text-align:left">NlogN</td>
<td style="text-align:left">N</td>
<td style="text-align:left">可用插入排序对小数组进行优化</td>
</tr>
</tbody>
</table>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/12/03/排序算法/" data-id="cj1psth8g0007fliq34k9z1d5" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-列表滚动自动隐藏无关元素" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/10/10/列表滚动自动隐藏无关元素/" class="article-date">
  <time datetime="2016-10-10T07:37:36.000Z" itemprop="datePublished">2016-10-10</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android/">Android</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/10/列表滚动自动隐藏无关元素/">Toolbar等自动隐藏</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>一直觉得知乎安卓客户端做的蛮好的，Toolbar+fab+BottomBar可以在滑动的时候自动隐藏和显示，让用户获得更大的视野来浏览正文</p>
<p><img src="http://bihu-face.image.alimmdn.com/1.gif?t=1476078830464" alt="知乎客户端"></p>
<p>大概想到了两种方式</p>
<ul>
<li><p>Framlayout+动画隐藏</p>
</li>
<li><p>CoordinatorLayout+自定义behavior</p>
</li>
</ul>
<h2 id="Framlayout-动画隐藏"><a href="#Framlayout-动画隐藏" class="headerlink" title="Framlayout+动画隐藏"></a>Framlayout+动画隐藏</h2><p>先看一哈xml布局</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">FrameLayout</span></span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">android.support.design.widget.AppBarLayout</span></span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span>&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">android.support.v7.widget.Toolbar</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/toolbar"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"attr/actionBarSize"</span>/&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;/<span class="name">android.support.design.widget.AppBarLayout</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">android.support.design.widget.FloatingActionButton</span></span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_gravity</span>=<span class="string">"bottom|end"</span></div><div class="line">        <span class="attr">android:layout_marginBottom</span>=<span class="string">"56dp"</span></div><div class="line">        <span class="attr">android:layout_marginEnd</span>=<span class="string">"16dp"</span>/&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">android.support.v7.widget.RecyclerView</span></span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>/&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"50dp"</span></div><div class="line">        <span class="attr">android:layout_gravity</span>=<span class="string">"bottom"</span></div><div class="line">        <span class="attr">android:textColor</span>=<span class="string">"@color/white"</span>/&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">FrameLayout</span>&gt;</span></div></pre></td></tr></table></figure>
<p>嗯哼没什么特别的，一些无关紧要的代码都删掉了。列表是用的RecyclerView，当然你换成其他的布局也是行得通的</p>
<p>然后就是重写一个RecyclerView的OnScrollListener</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">MyListener</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">OnScrollListener</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mIsShow = <span class="keyword">true</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mScrollOffset = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onScrolled</span><span class="params">(RecyclerView recyclerView, <span class="keyword">int</span> dx, <span class="keyword">int</span> dy)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onScrolled(recyclerView, dx, dy)；</div><div class="line">        <span class="keyword">if</span> (mScrollOffset &gt; scrollDistance &amp;&amp; mIsShow) &#123;</div><div class="line">            onHide();</div><div class="line">            mIsShow = <span class="keyword">false</span>;</div><div class="line">            mScrollOffset = <span class="number">0</span>;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mScrollOffset &lt; -scrollDistance &amp;&amp; !mIsShow) &#123;</div><div class="line">            onShow();</div><div class="line">            mIsShow = <span class="keyword">true</span>;</div><div class="line">            mScrollOffset = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> ((mIsShow &amp;&amp; dy &gt; <span class="number">0</span>) || (!mIsShow &amp;&amp; dy &lt; <span class="number">0</span>)) &#123;</div><div class="line">            mScrollOffset += dy;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">onHide</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">onShow</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">addMore</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>就判断一下滑动的方向&amp;&amp;触发条件进行Hide或者Show操作就行了撒，然后看一哈Activity中具体的实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">mRvGirls.addOnScrollListener(<span class="keyword">new</span> MyListener() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onHide</span><span class="params">()</span> </span>&#123;</div><div class="line">        mAppBar.animate().alpha(<span class="number">0</span>).translationY(-mToolbar.getBottom())</div><div class="line">            .setInterpolator(<span class="keyword">new</span> AccelerateInterpolator(<span class="number">2</span>));</div><div class="line">        mTvBottom.animate().alpha(<span class="number">0</span>).translationY(mTvBottom.getHeight())</div><div class="line">             .setInterpolator(<span class="keyword">new</span> AccelerateInterpolator(<span class="number">2</span>));</div><div class="line">        FrameLayout.LayoutParams lp = (FrameLayout.LayoutParams) mFab.getLayoutParams();</div><div class="line">        <span class="keyword">int</span> fabBottomMargin = lp.bottomMargin;</div><div class="line">        mFab.animate().translationY(mFab.getHeight() + fabBottomMargin)</div><div class="line">                        .setInterpolator(<span class="keyword">new</span> AnticipateOvershootInterpolator(<span class="number">5</span>)).start();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">     <span class="meta">@Override</span></div><div class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onShow</span><span class="params">()</span> </span>&#123;</div><div class="line">        mAppBar.animate().translationY(<span class="number">0</span>).alpha(<span class="number">225</span>).setInterpolator(<span class="keyword">new</span> AccelerateInterpolator(<span class="number">2</span>));</div><div class="line">        mFab.animate().translationY(<span class="number">0</span>).setInterpolator(<span class="keyword">new</span> AnticipateOvershootInterpolator(<span class="number">5</span>));</div><div class="line">        mTvBottom.animate().translationY(<span class="number">0</span>).alpha(<span class="number">225</span>).setInterpolator(<span class="keyword">new</span> AccelerateInterpolator(<span class="number">2</span>)).start();</div><div class="line">     &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>大概就是这个样子，note:不能直接对Toolbar使用动画，因为background是appbarlayout在控制，不然会出问题。还有最好要给RecyclerView添加一个Header，不然顶部会露一节出来。</p>
<p><img src="http://bihu-face.image.alimmdn.com/4.gif?t=1476082791389" alt="Gank"></p>
<h2 id="CoordinatorLayout-自定义behavior"><a href="#CoordinatorLayout-自定义behavior" class="headerlink" title="CoordinatorLayout+自定义behavior"></a>CoordinatorLayout+自定义behavior</h2><p>上面这种方法有个缺点，就是RecyclerView的ViewManger或者连RecyclerView都换掉了的话，那么隐藏的这部分逻辑也要换。用装逼的话来说。。。就是有耦合。。。</p>
<p>Coordinator是5.0后新出的噢，看起来就好屌噢，名字都不晓得什么意思，查了一下好像是协调布局的意思，以后就这么叫他了=。=</p>
<p>我们先试一下，把根布局换成CoordinatorLayout，再给Toolbar在xml里面加上这段代码</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">app:layout_scrollFlags="scroll|enterAlways"</div></pre></td></tr></table></figure>
<p>把我们为Adapter添加的listener去掉再运行一下，发现toolbar也是可以正常隐藏的哦，这是为啥子喃=。=</p>
<p>主要还是因为我们的CoordinatorLayout，文档里是这样说的</p>
<p><em>CoordinatorLayout is intended for two primary use       cases:</em></p>
<p><em>As a top-level application decor or chrome layout</em></p>
<p><em>As a container for a specific interaction with one or more child views</em></p>
<p><em>By specifying Behaviors for child views of a CoordinatorLayout you can provide many different interactions within a single parent and those views can also interact with one another. View classes can specify a default behavior when used as a child of a CoordinatorLayout using the DefaultBehavior annotation.</em></p>
<p><em>Behaviors may be used to implement a variety of interactions and additional layout modifications ranging from sliding drawers and panels to swipe-dismissable elements and buttons that stick to other elements as they move and animate.</em></p>
<p>简单来讲，CoordinatorLayout就是提供了一个桥梁给布局下的ChildView。具体的分析请看<a href="http://www.jianshu.com/p/a506ee4afecb" target="_blank" rel="external">Judy95</a>的一篇博客，说来也怪，Google上一搜很容易就碰到他的文章，我也是查资料的时候无意间看到的。</p>
<p>onNestedScroll中我们的逻辑和之前的都差不多</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNestedScroll</span><span class="params">(CoordinatorLayout coordinatorLayout, FloatingActionButton child, View target, <span class="keyword">int</span> dxConsumed, <span class="keyword">int</span> dyConsumed, <span class="keyword">int</span> dxUnconsumed, <span class="keyword">int</span> dyUnconsumed)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> fabBottomMargin = child.getBottom() + child.getHeight();</div><div class="line">    <span class="keyword">int</span> scrollDistance = <span class="number">20</span>;</div><div class="line">    <span class="keyword">if</span> (mOffset &gt; scrollDistance &amp;&amp; mIsShow) &#123;</div><div class="line">        child.animate().translationY(fabBottomMargin)</div><div class="line">                .setInterpolator(<span class="keyword">new</span> AnticipateOvershootInterpolator(<span class="number">5</span>)).start();</div><div class="line">        mIsShow = <span class="keyword">false</span>;</div><div class="line">        mOffset = <span class="number">0</span>;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mOffset &lt; -scrollDistance &amp;&amp; !mIsShow) &#123;</div><div class="line">        child.animate().translationY(<span class="number">0</span>)</div><div class="line">                .setInterpolator(<span class="keyword">new</span> AnticipateOvershootInterpolator(<span class="number">5</span>)).start();</div><div class="line">        mIsShow = <span class="keyword">true</span>;</div><div class="line">        mOffset = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> ((mIsShow &amp;&amp; dyConsumed &gt; <span class="number">0</span>) || (!mIsShow &amp;&amp; dyConsumed &lt; <span class="number">0</span>)) &#123;</div><div class="line">        mOffset += dyConsumed;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>就先到这里好了= =。。。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/10/10/列表滚动自动隐藏无关元素/" data-id="cj1psth8d0005fliq761y5xze" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-萌新指南" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/09/15/萌新指南/" class="article-date">
  <time datetime="2016-09-14T17:02:00.000Z" itemprop="datePublished">2016-09-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android/">Android</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/09/15/萌新指南/">Android 萌新指南</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="写在前面的话"><a href="#写在前面的话" class="headerlink" title="写在前面的话"></a>写在前面的话</h3><p>这篇文章是面向完全零基础的萌新写的，如果你是大佬，就不需要再看下去了。</p>
<p>最近总有人问我，学习编程是不是很难，程序猿是不是很累。</p>
<p>其实这些问题都很正常，我也很愿意和即将进入大学有意学习编程的同学谈谈关于编程的事情，因为你们需要一些指引，来进入这个新的阶段。</p>
<p>编程真的是一件很有意思的事情，学会变成就像变成了造物主，可以在代码中，尽情发挥你的创造力，创造任何你想创造的东西。在过去的20年里，对我而言，没有什么东西，比编程更能吸引我的智力活动了。</p>
<p>进入大学后，你们可能会接触到一些编程方面的训练（包括但不限于计算机，软件专业）。这本来是一件挺好的事情，让尽可能多的人接触到编程，因为它的用途真的很广。但是往往事与愿违，很多同学，就是在这里，失去了学习最主要的动力—-兴趣。<strong>在有些同学的眼里，谓之编程就是用一些复杂深晦的语言，用很长的学习周期，去解决一些简单的数学问题，然后，就言之没兴趣，不合适，无天赋</strong>。</p>
<p>然而这并不是编程的全部，编程应该是很有趣的，<strong>所谓的无趣阶段，是因为你还没有能力，用这些知识，来发挥创造。</strong>程序作为一种工具，你可以用它来解数学问题，也能它来做一些更实际的应用。当你玩累了，再回头去，才会发现数学题逻辑题、数据结构算法也是很有趣的东西。这些数学题，也能解决得很优雅。不知道你们是否还记得，面试有一道题：<a href="https://www.zhihu.com/question/23999095/answer/55061840?from=profile_answer_card" target="_blank" rel="external">一个逻辑学的教授，有三个很聪明的学生…</a>。对吧，当你入了门，也能做到这么酷的事情。</p>
<p>哦对了，大一学校教授的语言是C / C++，是不是听起来很感觉很无用。并不是，是因为你还没有到达使用它们的高度。说出来你可能不信，Linux 和 Git 都是这些用这些语言完成的，你可能连Git是什么都不知道，那怎么能指望用C / C++ 来创造一些东西呢。<strong>你感觉的无用，是你还没有足够的知识积累</strong> 。</p>
<p>So How？对于这种现状，我的建议是：上课认真听，耐着点性子，学会最基本东西。然后，再学习一门严谨的强类型的语言，如 Java，和一门轻松有趣的脚本语言，如JS，Python。当然了，想要一些立竿见影的东西？HTML, CSS或许是个是个不错的选择。</p>
<h3 id="Getting-Started"><a href="#Getting-Started" class="headerlink" title="Getting Started"></a>Getting Started</h3><p>不想再写那么多字了，罗列一些有用的建议：</p>
<ul>
<li>不管学习什么，首先你应该读一读<a href="https://github.com/ryanhanwu/How-To-Ask-Questions-The-Smart-Way/blob/master/README-zh_CN.md" target="_blank" rel="external">提问的智慧</a></li>
<li>不要指望一蹴而就，这件事没那么容易</li>
<li>科学上网是必要条件，一顿饭的钱不要吝啬</li>
<li>当然获取信息的能力也是</li>
<li>所以搜索引擎是你最好的老师</li>
<li>能Google就不要百度</li>
<li>不要问我怎么科学上网，我也不知道</li>
<li>不要害怕英文，中文很美，但有些事情中文真的办不到 </li>
<li>学校教的东西重要，但你需要和前沿技术保持一致</li>
<li>不要指望按部就班</li>
<li>学校的好坏重要，认清这一点</li>
<li>但是你今后人生的艰难，恰恰不是因为你没能考上一个满意的学校，而是在这所学校里，在一个能让自己自由充分成长的黄金四年里，把自己给荒废了</li>
<li>养成分享的好习惯</li>
</ul>
<h3 id="Guide"><a href="#Guide" class="headerlink" title="Guide"></a>Guide</h3><h4 id="Java-部分"><a href="#Java-部分" class="headerlink" title="Java 部分"></a>Java 部分</h4><ul>
<li><a href="http://www.liaoxuefeng.com/wiki/0013739516305929606dd18361248578c67b8067c8c017b000" target="_blank" rel="external">学习Git/GitHub</a></li>
<li><a href="https://www.sublimetext.com/" target="_blank" rel="external">下载文本编辑器 Sublime Text</a></li>
<li><a href="https://www.jetbrains.com/idea/download/#section=windows" target="_blank" rel="external">下载Java的IDE</a><br>不再推荐使用Eclipse</li>
<li>有一定基础的同学（对OOP有概念的，或者动手写过的），直接看《Thinking in Java》。从来没有写过程序的，看Java4Android这个视频，网易云课堂有，0-30集就好。当你觉得看视频的速度怎么这么慢，就可以去买本Java的书咯，什么都行，不是李刚的就行。</li>
</ul>
<h4 id="Android-部分"><a href="#Android-部分" class="headerlink" title="Android 部分"></a>Android 部分</h4><ul>
<li>下载IDE<a href="https://developer.android.com/studio/index.html" target="_blank" rel="external"> Android Studio</a>，不要问我为什么这个网站打不开</li>
<li>有问题试着用<a href="http://stackoverflow.com/" target="_blank" rel="external"> StackOverflow</a></li>
<li>推荐看《Android编程权威指南》，《第一行代码》也不错，就是老旧了些</li>
</ul>
<h4 id="参考书籍"><a href="#参考书籍" class="headerlink" title="参考书籍"></a>参考书籍</h4><h5 id="Note-粗体书籍的知识为必修知识、基础知识，但是你不一定要买这本书，你可以买任何包含了这些知识的其他书籍。剩下的，有私货，有娱乐消遣的，有进阶的，但是都是值得一看的"><a href="#Note-粗体书籍的知识为必修知识、基础知识，但是你不一定要买这本书，你可以买任何包含了这些知识的其他书籍。剩下的，有私货，有娱乐消遣的，有进阶的，但是都是值得一看的" class="headerlink" title="Note: 粗体书籍的知识为必修知识、基础知识，但是你不一定要买这本书，你可以买任何包含了这些知识的其他书籍。剩下的，有私货，有娱乐消遣的，有进阶的，但是都是值得一看的"></a>Note: 粗体书籍的知识为必修知识、基础知识，但是你不一定要买这本书，你可以买任何包含了这些知识的其他书籍。剩下的，有私货，有娱乐消遣的，有进阶的，但是都是值得一看的</h5><ul>
<li><strong>《Java开发实战经典》（李兴华 / 清华大学出版社）—-从来没有接触过编程的同学，Java从入门到不放弃</strong></li>
<li>《Thinking in java》( Bruce Eckel / 机械工业出版社)—OOP是什么？以及极好的训练耐心的书（贬义）</li>
<li>《算法》（Robert Sedgewick &amp; Kevin Wayne / 人民邮电出版社）—无聊的时候看看</li>
<li>《黑客与画家》（Paul Graham / 人民邮电出版社）—-What I talk about when I talk about geek and how to be a nerd.</li>
<li>《世界因你而不同》（李开复 / 中信出版社）—-鸡汤向，初中看的，李开复人品不评价，做的事确实还是挺厉害</li>
<li><strong>《Android编程权威指南第二版》（Bill Phillips / 人民邮电出版社）</strong>—-挺新的，翻译有些问题，不过白璧微瑕无伤大雅</li>
<li><strong>《第一行代码》（郭霖 / 人民邮电出版社）</strong>—-与上面那本可以相互替换，不过，没有必要两本同时买</li>
<li><strong>《Android开发艺术探索》（任玉刚 / 中国工信出版集团）—-进阶必备</strong></li>
<li>《Andoid群英传》（徐宜生 / 中国工信出版集团）—-进阶书，个人觉得性价比不高</li>
</ul>
<h4 id="学习路线"><a href="#学习路线" class="headerlink" title="学习路线"></a>学习路线</h4><p><img src="http://ac-8nxkymqc.clouddn.com/becb7c139063eb4e.png" alt="Anrdoi学习之道"></p>
<h4 id="电脑配置"><a href="#电脑配置" class="headerlink" title="电脑配置"></a>电脑配置</h4><p>最好有Mac咯<br>攒钱买 MacBook Pro，Air感觉有点小卡，不过还行<br>内存 8G+<br>CPU i5+<br>SSD 最好要有。。。不然会很惨的。。。<br>显示屏可以考虑，笔记本用久了眼睛真的很酸<br>有钱买个机械键盘，这样代码出错就没有理由怪键盘了<br><img src="http://ac-8nxkymqc.clouddn.com/f3ef07678dd2091c.png" alt="当然台式也不错"></p>
<p>好了就这些了，祝你们玩得愉快，感谢观看</p>
<p>愿你永远保持对技术的热爱和敬畏</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/09/15/萌新指南/" data-id="cj1psth8k000cfliqdq7tmvmw" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Algorithms/">Algorithms</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/04/20/AsyncTask 源码浅析/">AsyncTask 源码浅析</a>
          </li>
        
          <li>
            <a href="/2017/04/18/Android消息机制自问自答/">Android消息机制自问自答</a>
          </li>
        
          <li>
            <a href="/2017/04/14/讲义（三）/">讲义（三）</a>
          </li>
        
          <li>
            <a href="/2017/03/20/讲义（二）/">讲义（二）</a>
          </li>
        
          <li>
            <a href="/2017/03/18/讲义（一） /">讲义（一）</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 Simonla<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>